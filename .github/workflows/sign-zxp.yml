name: Build & Sign ZXP

on:
  workflow_dispatch:
    inputs:
      panel_path:
        description: "Path (in repo) to extension root containing CSXS/manifest.xml"
        required: true
        default: "com.sync.extension.ppro.panel"
      tsa_url:
        description: "Timestamp server URL"
        required: true
        default: "http://timestamp.digicert.com"
  push:
    tags:
      - "v*"

jobs:
  sign:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build CEP folders
        shell: pwsh
        run: |
          $os = "${{ matrix.os }}"
          $ae_dest = "com.sync.extension.ae.panel"
          $ppro_dest = "com.sync.extension.ppro.panel"
          
          # Clean existing folders
          if (Test-Path $ae_dest) { Remove-Item $ae_dest -Recurse -Force }
          if (Test-Path $ppro_dest) { Remove-Item $ppro_dest -Recurse -Force }
          
          # Copy AE extension files
          Copy-Item "extensions/ae-extension" $ae_dest -Recurse
          
          # Copy Premiere extension files  
          Copy-Item "extensions/premiere-extension" $ppro_dest -Recurse
          
          # Copy shared files to both extensions
          foreach ($dest in @($ae_dest, $ppro_dest)) {
            Copy-Item "ui" "$dest/ui" -Recurse
            Copy-Item "server" "$dest/server" -Recurse
            Copy-Item "icons" "$dest/icons" -Recurse
            Copy-Item "lib" "$dest/lib" -Recurse
            Copy-Item "bin" "$dest/bin" -Recurse
            Copy-Item "index.html" "$dest/"
            Copy-Item "host" "$dest/host" -Recurse
          }
          
          # Platform-specific binary filtering
          if ($os -eq "windows-latest") {
            # Remove macOS binaries for Windows package
            Remove-Item "$ae_dest/bin/darwin-arm64" -Recurse -Force -ErrorAction SilentlyContinue
            Remove-Item "$ae_dest/bin/darwin-x64" -Recurse -Force -ErrorAction SilentlyContinue
            Remove-Item "$ppro_dest/bin/darwin-arm64" -Recurse -Force -ErrorAction SilentlyContinue
            Remove-Item "$ppro_dest/bin/darwin-x64" -Recurse -Force -ErrorAction SilentlyContinue
          } else { # macos-latest
            # Remove Windows binaries for macOS package
            Remove-Item "$ae_dest/bin/win32-x64" -Recurse -Force -ErrorAction SilentlyContinue
            Remove-Item "$ppro_dest/bin/win32-x64" -Recurse -Force -ErrorAction SilentlyContinue
          }
          
          echo "Created CEP folders: $ae_dest, $ppro_dest for $os"

      - name: Verify panel folder + clean macOS cruft
        shell: pwsh
        run: |
          $Panel = Join-Path $env:GITHUB_WORKSPACE 'com.sync.extension.ppro.panel' # This input is for manual trigger, for matrix we check both
          if (-not (Test-Path (Join-Path $env:GITHUB_WORKSPACE 'com.sync.extension.ae.panel/CSXS/manifest.xml'))) {
            throw "CSXS/manifest.xml not found under: com.sync.extension.ae.panel"
          }
          if (-not (Test-Path (Join-Path $env:GITHUB_WORKSPACE 'com.sync.extension.ppro.panel/CSXS/manifest.xml'))) {
            throw "CSXS/manifest.xml not found under: com.sync.extension.ppro.panel"
          }
          # remove .DS_Store / __MACOSX
          Get-ChildItem -LiteralPath $env:GITHUB_WORKSPACE -Recurse -Force -Include '.DS_Store' | Remove-Item -Force -ErrorAction SilentlyContinue
          Get-ChildItem -LiteralPath $env:GITHUB_WORKSPACE -Recurse -Directory -Force -Filter '__MACOSX' | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          echo "Panel OK: com.sync.extension.ae.panel, com.sync.extension.ppro.panel"

      - name: Fetch ZXPSignCmd (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          git clone --depth=1 https://github.com/Adobe-CEP/CEP-Resources.git
          
          # Try multiple versions
          $versions = @("4.1.103", "4.1.102", "4.1.101", "4.1.100")
          $Exe = $null
          
          foreach ($version in $versions) {
            $testPath = "$env:GITHUB_WORKSPACE\CEP-Resources\ZXPSignCMD\$version\win64\ZXPSignCmd.exe"
            if (Test-Path $testPath) {
              $Exe = $testPath
              echo "Using ZXPSignCmd version: $version"
              break
            }
          }
          
          if (-not $Exe) { throw "ZXPSignCmd.exe not found in any version" }
          echo "ZXPSignCmd at: $Exe"
          
          # Verify executable permissions and properties
          $fileInfo = Get-Item $Exe
          echo "ZXPSignCmd file size: $($fileInfo.Length) bytes"
          echo "ZXPSignCmd last modified: $($fileInfo.LastWriteTime)"
          echo "ZXPSignCmd attributes: $($fileInfo.Attributes)"
          
          # Test ZXPSignCmd (help command always returns non-zero, that's normal)
          & $Exe -help
          echo "ZXPSignCmd help completed (exit code $LASTEXITCODE is normal)"
          # Reset error state - help command exit codes are expected
          $Error.Clear()
          $LASTEXITCODE = 0

      - name: Fetch ZXPSignCmd (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          git clone --depth=1 https://github.com/Adobe-CEP/CEP-Resources.git
          
          # Try multiple versions
          versions=("4.1.103" "4.1.102" "4.1.101" "4.1.100")
          Exe=""
          
          for version in "${versions[@]}"; do
            testPath="$GITHUB_WORKSPACE/CEP-Resources/ZXPSignCMD/$version/mac/ZXPSignCmd"
            if [ -f "$testPath" ]; then
              Exe="$testPath"
              echo "Using ZXPSignCmd version: $version"
              break
            fi
          done
          
          if [ -z "$Exe" ]; then echo "ZXPSignCmd not found in any version" && exit 1; fi
          echo "ZXPSignCmd at: $Exe"
          
          # Verify executable permissions and properties
          chmod +x "$Exe" # Ensure executable
          echo "ZXPSignCmd file size: $(stat -f%z "$Exe") bytes"
          echo "ZXPSignCmd last modified: $(stat -f%m "$Exe")"
          
          # Test ZXPSignCmd (help command always returns non-zero, that's normal)
          "$Exe" -help
          echo "ZXPSignCmd help completed (exit code $? is normal)"
          # Reset error state - help command exit codes are expected

      - name: Restore signing cert
        shell: pwsh
        run: |
          [IO.File]::WriteAllBytes("cert.p12",[Convert]::FromBase64String($env:P12_BASE64))
          $certSize = (Get-Item "cert.p12").Length
          echo "Certificate file size: $certSize bytes"
          if ($certSize -lt 1000) { throw "Certificate file too small, likely corrupted" }
          
          # Skip OpenSSL test to avoid hanging
          echo "Certificate restored successfully ($certSize bytes)"
        env:
          P12_BASE64: ${{ secrets.ZXP_P12_BASE64 }}
          ZXP_P12_PASSWORD: ${{ secrets.ZXP_P12_PASSWORD }}

      - name: Sign ZXP packages
        shell: pwsh
        run: |
          echo "=== Starting ZXP Signing Process ==="
          if ("${{ matrix.os }}" -eq "macos-latest") {
            $Exe = "$env:GITHUB_WORKSPACE/CEP-Resources/ZXPSignCMD/4.1.103/mac/ZXPSignCmd"
          } else {
            $Exe = "$env:GITHUB_WORKSPACE\CEP-Resources\ZXPSignCMD\4.1.103\win64\ZXPSignCmd.exe"
          }
          
          # Test certificate first (ZXPSignCmd doesn't verify .p12 files directly)
          echo "Certificate file exists: $(Test-Path "$env:GITHUB_WORKSPACE\cert.p12")"
          echo "Certificate size: $((Get-Item "$env:GITHUB_WORKSPACE\cert.p12").Length) bytes"
          
          # Check if CEP folders exist
          echo "AE folder exists: $(Test-Path "$env:GITHUB_WORKSPACE\com.sync.extension.ae.panel")"
          echo "Premiere folder exists: $(Test-Path "$env:GITHUB_WORKSPACE\com.sync.extension.ppro.panel")"
          
          # Sign AE extension
          $aeIn = "$env:GITHUB_WORKSPACE\com.sync.extension.ae.panel"
          $aeOut = "$env:GITHUB_WORKSPACE\sync-extension-ae-${{ matrix.os == 'windows-latest' && 'windows' || 'mac' }}-signed.zxp"
          $certPath = "$env:GITHUB_WORKSPACE\cert.p12"
          $password = "${{ secrets.ZXP_P12_PASSWORD }}"
          
          echo "Signing AE extension..."
          echo "Input: $aeIn"
          echo "Output: $aeOut"
          echo "Certificate: $certPath"
          echo "Password length: $($password.Length)"
          
          # Validate all required arguments are present
          if (-not (Test-Path $aeIn)) { throw "Input directory not found: $aeIn" }
          if (-not (Test-Path $certPath)) { throw "Certificate file not found: $certPath" }
          if ([string]::IsNullOrEmpty($password)) { throw "Password is empty" }
          
          echo "All required arguments validated successfully"
          
          # Try signing with timestamp first
          & $Exe -sign "$aeIn" "$aeOut" "$certPath" "$password" -tsa "${{ github.event.inputs.tsa_url }}"
          if ($LASTEXITCODE -ne 0) { 
            echo "AE signing with timestamp failed (exit $LASTEXITCODE), trying without timestamp..."
            & $Exe -sign "$aeIn" "$aeOut" "$certPath" "$password"
            if ($LASTEXITCODE -ne 0) { throw "ZXPSignCmd failed for AE with exit $LASTEXITCODE" }
          }
          
          # Sign Premiere extension
          $pproIn = "$env:GITHUB_WORKSPACE\com.sync.extension.ppro.panel"
          $pproOut = "$env:GITHUB_WORKSPACE\sync-extension-premiere-${{ matrix.os == 'windows-latest' && 'windows' || 'mac' }}-signed.zxp"
          
          echo "Signing Premiere extension..."
          echo "Input: $pproIn"
          echo "Output: $pproOut"
          
          # Validate all required arguments are present
          if (-not (Test-Path $pproIn)) { throw "Input directory not found: $pproIn" }
          echo "Premiere extension arguments validated successfully"
          
          & $Exe -sign "$pproIn" "$pproOut" "$certPath" "$password" -tsa "${{ github.event.inputs.tsa_url }}"
          if ($LASTEXITCODE -ne 0) { 
            echo "Premiere signing with timestamp failed (exit $LASTEXITCODE), trying without timestamp..."
            & $Exe -sign "$pproIn" "$pproOut" "$certPath" "$password"
            if ($LASTEXITCODE -ne 0) { throw "ZXPSignCmd failed for Premiere with exit $LASTEXITCODE" }
          }

      - name: Verify signatures (prints cert/timestamp info)
        shell: pwsh
        run: |
          if ("${{ matrix.os }}" -eq "macos-latest") {
            $Exe = "$env:GITHUB_WORKSPACE/CEP-Resources/ZXPSignCMD/4.1.103/mac/ZXPSignCmd"
          } else {
            $Exe = "$env:GITHUB_WORKSPACE\CEP-Resources\ZXPSignCMD\4.1.103\win64\ZXPSignCmd.exe"
          }
          
          echo "Verifying AE extension..."
          & $Exe -verify "$env:GITHUB_WORKSPACE\sync-extension-ae-${{ matrix.os == 'windows-latest' && 'windows' || 'mac' }}-signed.zxp" -certinfo
          if ($LASTEXITCODE -ne 0) { throw "AE verify failed" }
          
          echo "Verifying Premiere extension..."
          & $Exe -verify "$env:GITHUB_WORKSPACE\sync-extension-premiere-${{ matrix.os == 'windows-latest' && 'windows' || 'mac' }}-signed.zxp" -certinfo
          if ($LASTEXITCODE -ne 0) { throw "Premiere verify failed" }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: signed-zxp-packages-${{ matrix.os }}
          path: |
            sync-extension-ae-${{ matrix.os == 'windows-latest' && 'windows' || 'mac' }}-signed.zxp
            sync-extension-premiere-${{ matrix.os == 'windows-latest' && 'windows' || 'mac' }}-signed.zxp

      - name: Get tag message
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        id: tag_message
        run: |
          TAG_MESSAGE=$(git tag -l --format='%(contents)' ${{ github.ref_name }})
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$TAG_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload to GitHub Release (tag builds)
        if: (startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch') && matrix.os == 'windows-latest'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ${{ steps.tag_message.outputs.message }}
            
            **Downloads:**
            - After Effects: `sync-extension-ae-windows-signed.zxp` and `sync-extension-ae-mac-signed.zxp`
            - Premiere Pro: `sync-extension-premiere-windows-signed.zxp` and `sync-extension-premiere-mac-signed.zxp`
            
            Choose the appropriate package for your platform and application.
          files: |
            sync-extension-ae-windows-signed.zxp
            sync-extension-premiere-windows-signed.zxp
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: Upload macOS ZXPs to Release
        if: (startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch') && matrix.os == 'macos-latest'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            sync-extension-ae-mac-signed.zxp
            sync-extension-premiere-mac-signed.zxp